# /frontend/nginx.conf  -> copied to /etc/nginx/templates/default.conf.template in the image

server {
  listen 80;

  # Built SPA
  root /usr/share/nginx/html;
  index index.html;

  # Re-resolve Docker service names
  resolver 127.0.0.11 ipv6=off valid=10s;

  # Upstream service names + ports (Docker network)
  set $backend_host backend-server;
  set $backend_port 8181;
  set $n8n_host n8n;
  set $n8n_port 5678;

  # ---- SPA root ----
  location / {
    try_files $uri /index.html;
  }

  # ---- REST -> backend ----
  location /api/ {
    proxy_pass http://$backend_host:$backend_port$request_uri;
    proxy_http_version 1.1;

    proxy_set_header Host              $http_host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # ---- WebSockets -> backend (/ws/) ----
  location /ws/ {
    proxy_pass http://$backend_host:$backend_port$request_uri;
    proxy_http_version 1.1;

    proxy_set_header Host              $http_host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # websockets
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        "upgrade";

    proxy_read_timeout 86400s;
  }

  # ---- App previews served by backend (/apps/...) ----
  location /apps/ {
    proxy_pass http://$backend_host:$backend_port$request_uri;
    proxy_http_version 1.1;

    proxy_set_header Host              $http_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For   $remote_addr;
  }

  # ---- n8n under /n8n/ (IMPORTANT: forward host INCLUDING PORT) ----
  location /n8n/ {
    proxy_pass http://$n8n_host:$n8n_port$request_uri;
    proxy_http_version 1.1;

    # These two lines make n8n's expected origin = "localhost:3737"
    proxy_set_header Host               $http_host;
    proxy_set_header X-Forwarded-Host   $http_host;

    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Prefix /n8n;

    # websockets / SSE
    proxy_set_header Upgrade            $http_upgrade;
    proxy_set_header Connection         "upgrade";

    proxy_connect_timeout 5s;
    proxy_send_timeout    60s;
    proxy_read_timeout    86400s;
  }
}
